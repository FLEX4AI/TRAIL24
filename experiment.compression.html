<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Compression Notebook">

<title>Compression – TRAIL24</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Compression – TRAIL24">
<meta property="og:description" content="Compression Notebook">
<meta property="og:site_name" content="TRAIL24">
<meta name="twitter:title" content="Compression – TRAIL24">
<meta name="twitter:description" content="Compression Notebook">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">TRAIL24</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Compression</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.preprocess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preprocess</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cluster</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiment.preprocess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preprocess</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiment.tahercluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Taher Cluster</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiment.cluster.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clustering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./experiment.interpret.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interpretation</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Compression</h1>
</div>

<div>
  <div class="description">
    Compression Notebook
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div id="622c2079-7709-4d41-a538-70fa86a489d8" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#from TRAIL24.compression.pruning import *</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#from torchmetrics import MeanSquaredError, SymmetricMeanAbsolutePercentageError</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader, Dataset</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#from memory_profiler import memory_usage</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> resource</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchmetrics <span class="im">import</span> MeanSquaredError, SymmetricMeanAbsolutePercentageError</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="feb77284-c0c4-4fbc-a35f-6a2a671242fa" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../data/df_cluster_0.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pickle.load(f)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># In[5]:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'OKKKK'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>num_rows <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the halfway point</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>halfway_point <span class="op">=</span> num_rows <span class="op">//</span> <span class="dv">4</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the first half of the rows</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.iloc[:halfway_point]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OrdinalEncoder</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to optimize data types</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_data_types(df):</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optimize numeric columns</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df.select_dtypes(include<span class="op">=</span>[<span class="st">'int'</span>]).columns:</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> df[col].astype(<span class="st">'int32'</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df.select_dtypes(include<span class="op">=</span>[<span class="st">'float'</span>]).columns:</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> df[col].astype(<span class="st">'float32'</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optimize object columns</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>]).columns:</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        num_unique_values <span class="op">=</span> <span class="bu">len</span>(df[col].unique())</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        num_total_values <span class="op">=</span> <span class="bu">len</span>(df[col])</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_unique_values <span class="op">/</span> num_total_values <span class="op">&lt;</span> <span class="fl">0.5</span>:</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> df[col].astype(<span class="st">'category'</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data and remove the first and last columns</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co">#df = pd.read_csv('df_labeled0.csv')</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.iloc[:, <span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize data types</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> optimize_data_types(df)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the window size for lagged inputs</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">40</span>  <span class="co"># Replace N with your desired window size</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to process each chunk</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_chunk(chunk, window_size):</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> []</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> tqdm(chunk.iterrows()):</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> row.values</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(window_size, <span class="bu">len</span>(values)):</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>            lagged_inputs <span class="op">=</span> values[t<span class="op">-</span>window_size:t]</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>            target_value <span class="op">=</span> values[t]</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate realistic datetime values using the index</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            base_date <span class="op">=</span> pd.Timestamp(<span class="st">'2009-07-14 00:00:00'</span>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> base_date <span class="op">+</span> pd.Timedelta(hours<span class="op">=</span>t)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            year <span class="op">=</span> timestamp.year</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            month <span class="op">=</span> timestamp.month</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>            day <span class="op">=</span> timestamp.day</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>            hour <span class="op">=</span> timestamp.hour</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>            data.append(<span class="bu">list</span>(lagged_inputs) <span class="op">+</span> [year, month, day, hour, target_value])</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty DataFrame to store results</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="ss">f'lag_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, window_size<span class="op">+</span><span class="dv">1</span>)] <span class="op">+</span> [<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>, <span class="st">'target'</span>]</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>df_transformed <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>columns)</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Process the data in chunks</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>chunk_size <span class="op">=</span> <span class="dv">100</span>  <span class="co"># Adjust based on available memory</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> start_row <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">0</span>, df.shape[<span class="dv">0</span>], chunk_size)):</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    chunk <span class="op">=</span> df.iloc[start_row:start_row <span class="op">+</span> chunk_size]</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> process_chunk(chunk, window_size)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    df_chunk_transformed <span class="op">=</span> pd.DataFrame(data, columns<span class="op">=</span>columns)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    df_transformed <span class="op">=</span> pd.concat([df_transformed, df_chunk_transformed], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure year, month, day, and hour are integers</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'year'</span>] <span class="op">=</span> df_transformed[<span class="st">'year'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'month'</span>] <span class="op">=</span> df_transformed[<span class="st">'month'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'day'</span>] <span class="op">=</span> df_transformed[<span class="st">'day'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'hour'</span>] <span class="op">=</span> df_transformed[<span class="st">'hour'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Create datetime column</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    df_transformed[<span class="st">'date_time'</span>] <span class="op">=</span> pd.to_datetime(df_transformed[[<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>]])</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Date conversion successful."</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Error during date conversion:"</span>, e)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply OrdinalEncoder to month, day, hour columns</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>ordinal_encoder <span class="op">=</span> OrdinalEncoder()</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>df_transformed[[<span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>]] <span class="op">=</span> ordinal_encoder.fit_transform(df_transformed[[<span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>]])</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Transformation complete. The new dataset is saved as 'transformed_dataset.csv'."</span>)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_transformed[[<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>]].dtypes)</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a><span class="co"># In[9]:</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_transformed[<span class="st">'month'</span>].unique())  <span class="co"># Should be within 1-12</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_transformed[<span class="st">'day'</span>].unique())    <span class="co"># Should be within 1-31</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_transformed[<span class="st">'hour'</span>].unique())   <span class="co"># Should be within 0-23</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a><span class="co"># In[10]:</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the date columns to datetime</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'year1'</span>] <span class="op">=</span> df_transformed[<span class="st">'year'</span>]</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'month1'</span>] <span class="op">=</span> df_transformed[<span class="st">'month'</span>]</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'day1'</span>] <span class="op">=</span> df_transformed[<span class="st">'day'</span>]</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'hour1'</span>] <span class="op">=</span> df_transformed[<span class="st">'hour'</span>]</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">"target1"</span>] <span class="op">=</span> df_transformed[<span class="st">"target"</span>]</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the date ranges for training and testing</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>train_start_date <span class="op">=</span> <span class="st">'2009-07-14'</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>train_end_date <span class="op">=</span> <span class="st">'2010-12-15'</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>test_start_date <span class="op">=</span> <span class="st">'2010-12-15'</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>test_end_date <span class="op">=</span> <span class="st">'2011-01-01'</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the date columns to datetime</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'year'</span>] <span class="op">=</span> df_transformed[<span class="st">'year'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'month'</span>] <span class="op">=</span> df_transformed[<span class="st">'month'</span>].astype(<span class="bu">int</span>)<span class="op">+</span><span class="dv">1</span></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'day'</span>] <span class="op">=</span> df_transformed[<span class="st">'day'</span>].astype(<span class="bu">int</span>)<span class="op">+</span><span class="dv">1</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'hour'</span>] <span class="op">=</span> df_transformed[<span class="st">'hour'</span>].astype(<span class="bu">int</span>)<span class="op">+</span><span class="dv">1</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a datetime column</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>df_transformed[<span class="st">'date_time'</span>] <span class="op">=</span> pd.to_datetime(df_transformed[[<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>]])</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>df_sample <span class="op">=</span> df_transformed.loc[:<span class="dv">12825</span>]</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the datetime column as the index</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>df_transformed.set_index(<span class="st">'date_time'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>df_sample.set_index(<span class="st">'date_time'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the irrelevant columns</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>df_transformed.drop(columns<span class="op">=</span>[<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>,<span class="st">'target'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>df_sample.drop(columns<span class="op">=</span>[<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>, <span class="st">'hour'</span>,<span class="st">'target'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>df_transformed <span class="op">=</span> df_transformed.sort_index()</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>df_sample <span class="op">=</span> df_sample.sort_index()</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data into training and testing sets</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> df_transformed.loc[train_start_date:train_end_date]</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> df_transformed.loc[test_start_date:test_end_date]</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the scaler on the first 40 columns of the training data</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>scaler.fit(train.iloc[:, :<span class="dv">40</span>])</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform the first 40 columns of both training and validation data</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>train.iloc[:, :<span class="dv">40</span>] <span class="op">=</span> scaler.transform(train.iloc[:, :<span class="dv">40</span>])</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>test.iloc[:, :<span class="dv">40</span>] <span class="op">=</span> scaler.transform(test.iloc[:, :<span class="dv">40</span>])</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample data for the first building</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> df_sample.loc[test_start_date:test_end_date]</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>sample.iloc[:, :<span class="dv">40</span>] <span class="op">=</span> scaler.transform(sample.iloc[:, :<span class="dv">40</span>])</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> df_transformed, df</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>gc.collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OKKKK</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bb8bcd617f36442eaeed4be527207c1f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"29ea773372a74b70943e1d6a1110ae33","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5bdf3ca5d35641708a59ef8d4a3bf563","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ef61cd0f51a94011a8b32f16fcdfb49d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3ab94c4a38534922a6e9c87760a2a61f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3c8eaec55f454b64a4ad8904f534c923","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"51f5d139133d4cbeb7b4355dd0be9956","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"754523b6bfc247049faa31e08c188e4b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6e5fce1b28b44f548e7c201303776f44","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Date conversion successful.
Transformation complete. The new dataset is saved as 'transformed_dataset.csv'.
year       int64
month    float64
day      float64
hour     float64
dtype: object
[ 6.  7.  8.  9. 10. 11.  0.  1.  2.  3.  4.  5.]
[14. 15. 16. 17. 18. 19. 20. 21. 22. 23. 24. 25. 26. 27. 28. 29. 30.  0.
  1.  2.  3.  4.  5.  6.  7.  8.  9. 10. 11. 12. 13.]
[16. 17. 18. 19. 20. 21. 22. 23.  0.  1.  2.  3.  4.  5.  6.  7.  8.  9.
 10. 11. 12. 13. 14. 15.]</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">SettingWithCopyError</span>                      Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_2151806/3735520156.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">--&gt; 148</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">with</span> open<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">'../data/df_cluster_0.pkl'</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'rb'</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">as</span> f<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">    149</span>     df <span class="ansi-blue-fg">=</span> pickle<span class="ansi-blue-fg">.</span>load<span class="ansi-blue-fg">(</span>f<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    150</span> 
<span class="ansi-green-fg ansi-bold">    151</span> 

<span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/pandas/core/frame.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, labels, axis, index, columns, level, inplace, errors)</span>
<span class="ansi-green-fg ansi-bold">   5577</span>                 weight  <span class="ansi-cyan-fg">250.0</span>   <span class="ansi-cyan-fg">150.0</span>
<span class="ansi-green-fg ansi-bold">   5578</span>         falcon  speed   <span class="ansi-cyan-fg">320.0</span>   <span class="ansi-cyan-fg">250.0</span>
<span class="ansi-green-fg ansi-bold">   5579</span>                 weight  <span class="ansi-cyan-fg">1.0</span>     <span class="ansi-cyan-fg">0.8</span>
<span class="ansi-green-fg ansi-bold">   5580</span>         """
<span class="ansi-green-fg">-&gt; 5581</span><span class="ansi-red-fg">         return super().drop(
</span><span class="ansi-green-fg ansi-bold">   5582</span>             labels<span class="ansi-blue-fg">=</span>labels<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg ansi-bold">   5583</span>             axis<span class="ansi-blue-fg">=</span>axis<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg ansi-bold">   5584</span>             index<span class="ansi-blue-fg">=</span>index<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, labels, axis, index, columns, level, inplace, errors)</span>
<span class="ansi-green-fg ansi-bold">   4787</span>             <span class="ansi-green-fg">if</span> labels <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">   4788</span>                 obj <span class="ansi-blue-fg">=</span> obj<span class="ansi-blue-fg">.</span>_drop_axis<span class="ansi-blue-fg">(</span>labels<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">,</span> level<span class="ansi-blue-fg">=</span>level<span class="ansi-blue-fg">,</span> errors<span class="ansi-blue-fg">=</span>errors<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4789</span> 
<span class="ansi-green-fg ansi-bold">   4790</span>         <span class="ansi-green-fg">if</span> inplace<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 4791</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_update_inplace<span class="ansi-blue-fg">(</span>obj<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4792</span>             <span class="ansi-green-fg">return</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-fg ansi-bold">   4793</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">   4794</span>             <span class="ansi-green-fg">return</span> obj

<span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, result, verify_is_copy)</span>
<span class="ansi-green-fg ansi-bold">   4895</span>         <span class="ansi-red-fg"># decision that we may revisit in the future.</span>
<span class="ansi-green-fg ansi-bold">   4896</span>         self<span class="ansi-blue-fg">.</span>_reset_cache<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4897</span>         self<span class="ansi-blue-fg">.</span>_clear_item_cache<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4898</span>         self<span class="ansi-blue-fg">.</span>_mgr <span class="ansi-blue-fg">=</span> result<span class="ansi-blue-fg">.</span>_mgr
<span class="ansi-green-fg">-&gt; 4899</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_maybe_update_cacher<span class="ansi-blue-fg">(</span>verify_is_copy<span class="ansi-blue-fg">=</span>verify_is_copy<span class="ansi-blue-fg">,</span> inplace<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, clear, verify_is_copy, inplace)</span>
<span class="ansi-green-fg ansi-bold">   4012</span>         <span class="ansi-green-fg">if</span> using_copy_on_write<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">   4013</span>             <span class="ansi-green-fg">return</span>
<span class="ansi-green-fg ansi-bold">   4014</span> 
<span class="ansi-green-fg ansi-bold">   4015</span>         <span class="ansi-green-fg">if</span> verify_is_copy<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 4016</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_check_setitem_copy<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">"referent"</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4017</span> 
<span class="ansi-green-fg ansi-bold">   4018</span>         <span class="ansi-green-fg">if</span> clear<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">   4019</span>             self<span class="ansi-blue-fg">.</span>_clear_item_cache<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/pandas/core/generic.py</span> in <span class="ansi-cyan-fg">?</span><span class="ansi-blue-fg">(self, t, force)</span>
<span class="ansi-green-fg ansi-bold">   4469</span>                 <span class="ansi-blue-fg">"indexing.html#returning-a-view-versus-a-copy"</span>
<span class="ansi-green-fg ansi-bold">   4470</span>             )
<span class="ansi-green-fg ansi-bold">   4471</span> 
<span class="ansi-green-fg ansi-bold">   4472</span>         <span class="ansi-green-fg">if</span> value <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">"raise"</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 4473</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> SettingWithCopyError<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   4474</span>         <span class="ansi-green-fg">if</span> value <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">"warn"</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">   4475</span>             warnings<span class="ansi-blue-fg">.</span>warn<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">,</span> SettingWithCopyWarning<span class="ansi-blue-fg">,</span> stacklevel<span class="ansi-blue-fg">=</span>find_stack_level<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">SettingWithCopyError</span>: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</pre>
</div>
</div>
</div>
<div id="27cefcad-ea56-43f2-a21c-fc9583941c7b" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate a StandardScaler</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize only the first 40 columns</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sample.iloc[:, :<span class="dv">40</span>] <span class="op">=</span> scaler.fit_transform(sample.iloc[:, :<span class="dv">40</span>])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the updated DataFrame</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2009-07-14 00:00:00  2009-07-14 01:00:00  2009-07-14 02:00:00  \
1                  0.692                0.761                0.725   
2                  1.310                2.360                1.693   
3                  0.177                0.324                0.317   
4                  0.048                0.183                0.101   
5                  0.614                1.142                1.139   
..                   ...                  ...                  ...   
908                0.128                0.297                0.284   
909                0.229                0.402                0.348   
912                0.626                0.691                0.375   
913                0.179                0.183                0.178   
915                0.448                0.372                0.292   

     2009-07-14 03:00:00  2009-07-14 04:00:00  2009-07-14 05:00:00  \
1                  0.546                0.729                0.755   
2                  1.738                0.833                0.789   
3                  0.311                0.305                0.304   
4                  0.175                1.062                0.322   
5                  0.836                0.805                0.826   
..                   ...                  ...                  ...   
908                0.663                0.250                0.183   
909                0.297                0.393                0.339   
912                0.491                0.386                0.252   
913                0.199                0.183                0.172   
915                0.292                0.283                0.287   

     2009-07-14 06:00:00  2009-07-14 07:00:00  2009-07-14 08:00:00  \
1                  0.773                0.743                0.911   
2                  0.709                0.756                1.397   
3                  0.303                0.300                1.213   
4                  0.151                0.241                0.157   
5                  0.511                0.707                0.447   
..                   ...                  ...                  ...   
908                0.321                0.184                0.219   
909                0.306                0.382                0.564   
912                0.508                0.539                0.875   
913                0.172                0.181                0.449   
915                0.289                3.976                0.354   

     2009-07-14 09:00:00  ...  2010-12-31 14:00:00  2010-12-31 15:00:00  \
1                  0.579  ...                0.809                1.901   
2                  4.208  ...                0.782                0.961   
3                  0.730  ...                1.998                1.540   
4                  0.117  ...                0.744                6.229   
5                  0.296  ...                3.103                2.959   
..                   ...  ...                  ...                  ...   
908                0.621  ...                0.125                0.149   
909                0.499  ...                0.930                0.755   
912                0.673  ...                1.560                1.561   
913                0.390  ...                0.579                1.443   
915                0.276  ...                5.138                1.230   

     2010-12-31 16:00:00  2010-12-31 17:00:00  2010-12-31 18:00:00  \
1                  2.744                4.013                3.007   
2                  2.522                5.785                6.388   
3                  4.620                5.607                6.813   
4                  5.182                6.428                7.117   
5                  2.676                5.144                6.581   
..                   ...                  ...                  ...   
908                0.119                0.194                0.197   
909                2.359                1.301                2.171   
912                4.066                3.383                1.229   
913                0.646                1.480                0.585   
915                1.054                1.582                1.952   

     2010-12-31 19:00:00  2010-12-31 20:00:00  2010-12-31 21:00:00  \
1                  2.166                1.617                1.636   
2                  3.271                2.947                3.106   
3                  4.491                1.505                1.457   
4                  6.624                3.757                2.395   
5                  6.868                2.603                2.259   
..                   ...                  ...                  ...   
908                0.319                0.293                0.245   
909                4.659                5.219                1.733   
912                1.201                3.447                1.886   
913                0.732                0.589                0.582   
915                1.666                1.675                0.877   

     2010-12-31 22:00:00  2010-12-31 23:00:00  
1                  1.700                1.674  
2                  3.241                2.846  
3                  1.089                1.124  
4                  2.286                2.213  
5                  1.688                1.628  
..                   ...                  ...  
908                0.166                0.120  
909                1.957                1.743  
912                2.004                1.569  
913                0.591                1.479  
915                0.876                0.879  

[743 rows x 12864 columns]</code></pre>
</div>
</div>
<div id="bc5b3095-b315-4c58-a3fb-e354c77d27b3" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_transformed.iloc[:, :<span class="dv">40</span>].<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>lag_1     24.517
lag_2     24.517
lag_3     24.517
lag_4     24.517
lag_5     24.517
lag_6     24.517
lag_7     24.517
lag_8     24.517
lag_9     24.517
lag_10    24.517
lag_11    24.517
lag_12    24.517
lag_13    24.517
lag_14    24.517
lag_15    24.517
lag_16    24.517
lag_17    24.517
lag_18    24.517
lag_19    24.517
lag_20    24.517
lag_21    24.517
lag_22    24.517
lag_23    24.517
lag_24    24.517
lag_25    24.517
lag_26    24.517
lag_27    24.517
lag_28    24.517
lag_29    24.517
lag_30    24.517
lag_31    24.517
lag_32    24.517
lag_33    24.517
lag_34    24.517
lag_35    24.517
lag_36    24.517
lag_37    24.517
lag_38    24.517
lag_39    24.517
lag_40    24.517
dtype: float32</code></pre>
</div>
</div>
<div id="df3fe866-a752-4d4c-a006-d14552e3f9e1" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">lag_1</th>
<th data-quarto-table-cell-role="th">lag_2</th>
<th data-quarto-table-cell-role="th">lag_3</th>
<th data-quarto-table-cell-role="th">lag_4</th>
<th data-quarto-table-cell-role="th">lag_5</th>
<th data-quarto-table-cell-role="th">lag_6</th>
<th data-quarto-table-cell-role="th">lag_7</th>
<th data-quarto-table-cell-role="th">lag_8</th>
<th data-quarto-table-cell-role="th">lag_9</th>
<th data-quarto-table-cell-role="th">lag_10</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">lag_36</th>
<th data-quarto-table-cell-role="th">lag_37</th>
<th data-quarto-table-cell-role="th">lag_38</th>
<th data-quarto-table-cell-role="th">lag_39</th>
<th data-quarto-table-cell-role="th">lag_40</th>
<th data-quarto-table-cell-role="th">year1</th>
<th data-quarto-table-cell-role="th">month1</th>
<th data-quarto-table-cell-role="th">day1</th>
<th data-quarto-table-cell-role="th">hour1</th>
<th data-quarto-table-cell-role="th">target1</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">date_time</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-12-15 00:00:00</td>
<td>0.057708</td>
<td>0.070939</td>
<td>0.079591</td>
<td>0.056690</td>
<td>0.192157</td>
<td>0.119895</td>
<td>0.046106</td>
<td>0.039592</td>
<td>0.043052</td>
<td>0.093331</td>
<td>...</td>
<td>0.350626</td>
<td>0.184117</td>
<td>0.315105</td>
<td>0.208035</td>
<td>0.301671</td>
<td>2010</td>
<td>11.0</td>
<td>13.0</td>
<td>23.0</td>
<td>3.437</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-12-15 01:00:00</td>
<td>0.067060</td>
<td>0.075238</td>
<td>0.053590</td>
<td>0.181650</td>
<td>0.113339</td>
<td>0.043584</td>
<td>0.037427</td>
<td>0.040698</td>
<td>0.088227</td>
<td>0.244476</td>
<td>...</td>
<td>0.174049</td>
<td>0.297874</td>
<td>0.196659</td>
<td>0.285174</td>
<td>0.330683</td>
<td>2010</td>
<td>11.0</td>
<td>14.0</td>
<td>0.0</td>
<td>1.874</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-12-15 02:00:00</td>
<td>0.074206</td>
<td>0.052855</td>
<td>0.179158</td>
<td>0.111784</td>
<td>0.042986</td>
<td>0.036913</td>
<td>0.040140</td>
<td>0.087017</td>
<td>0.241123</td>
<td>0.234385</td>
<td>...</td>
<td>0.293788</td>
<td>0.193961</td>
<td>0.281262</td>
<td>0.326147</td>
<td>0.177829</td>
<td>2010</td>
<td>11.0</td>
<td>14.0</td>
<td>1.0</td>
<td>1.832</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-12-15 03:00:00</td>
<td>0.052214</td>
<td>0.176984</td>
<td>0.110427</td>
<td>0.042465</td>
<td>0.036465</td>
<td>0.039653</td>
<td>0.085961</td>
<td>0.238197</td>
<td>0.231541</td>
<td>0.327908</td>
<td>...</td>
<td>0.191608</td>
<td>0.277850</td>
<td>0.322189</td>
<td>0.175671</td>
<td>0.171734</td>
<td>2010</td>
<td>11.0</td>
<td>14.0</td>
<td>2.0</td>
<td>0.774</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-12-15 04:00:00</td>
<td>0.176760</td>
<td>0.110288</td>
<td>0.042411</td>
<td>0.036419</td>
<td>0.039602</td>
<td>0.085852</td>
<td>0.237895</td>
<td>0.231248</td>
<td>0.327492</td>
<td>0.157567</td>
<td>...</td>
<td>0.277498</td>
<td>0.321781</td>
<td>0.175449</td>
<td>0.171517</td>
<td>0.072464</td>
<td>2010</td>
<td>11.0</td>
<td>14.0</td>
<td>3.0</td>
<td>0.723</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-12-31 20:00:00</td>
<td>0.064250</td>
<td>0.046326</td>
<td>0.036749</td>
<td>0.037895</td>
<td>0.042806</td>
<td>0.088559</td>
<td>0.088886</td>
<td>0.126127</td>
<td>0.183747</td>
<td>0.178836</td>
<td>...</td>
<td>0.066215</td>
<td>0.155592</td>
<td>0.224589</td>
<td>0.328453</td>
<td>0.246115</td>
<td>2010</td>
<td>11.0</td>
<td>30.0</td>
<td>19.0</td>
<td>2.166</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-12-31 21:00:00</td>
<td>0.045706</td>
<td>0.036258</td>
<td>0.037388</td>
<td>0.042234</td>
<td>0.087374</td>
<td>0.087697</td>
<td>0.124440</td>
<td>0.181289</td>
<td>0.176444</td>
<td>0.216901</td>
<td>...</td>
<td>0.153510</td>
<td>0.221585</td>
<td>0.324060</td>
<td>0.242823</td>
<td>0.174910</td>
<td>2010</td>
<td>11.0</td>
<td>30.0</td>
<td>20.0</td>
<td>1.617</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-12-31 22:00:00</td>
<td>0.035990</td>
<td>0.037112</td>
<td>0.041921</td>
<td>0.086728</td>
<td>0.087048</td>
<td>0.123519</td>
<td>0.179948</td>
<td>0.175139</td>
<td>0.215297</td>
<td>0.088972</td>
<td>...</td>
<td>0.219946</td>
<td>0.321662</td>
<td>0.241026</td>
<td>0.173616</td>
<td>0.129611</td>
<td>2010</td>
<td>11.0</td>
<td>30.0</td>
<td>21.0</td>
<td>1.636</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-12-31 23:00:00</td>
<td>0.036820</td>
<td>0.041592</td>
<td>0.086046</td>
<td>0.086364</td>
<td>0.122549</td>
<td>0.178534</td>
<td>0.173763</td>
<td>0.213605</td>
<td>0.088273</td>
<td>0.111256</td>
<td>...</td>
<td>0.319135</td>
<td>0.239133</td>
<td>0.172252</td>
<td>0.128592</td>
<td>0.130103</td>
<td>2010</td>
<td>11.0</td>
<td>30.0</td>
<td>22.0</td>
<td>1.700</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2011-01-01 00:00:00</td>
<td>0.041244</td>
<td>0.085327</td>
<td>0.085643</td>
<td>0.121525</td>
<td>0.177043</td>
<td>0.172311</td>
<td>0.211820</td>
<td>0.087536</td>
<td>0.110326</td>
<td>0.104806</td>
<td>...</td>
<td>0.237135</td>
<td>0.170813</td>
<td>0.127518</td>
<td>0.129016</td>
<td>0.134064</td>
<td>2010</td>
<td>11.0</td>
<td>30.0</td>
<td>23.0</td>
<td>1.674</td>
</tr>
</tbody>
</table>

<p>409 rows × 45 columns</p>
</div>
</div>
</div>
<div id="0ddaa8ae-d4d9-4d9f-b5ec-e632e23b51d1" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomDataset(Dataset):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dataframe):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dataframe <span class="op">=</span> dataframe</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> <span class="va">self</span>.dataframe.iloc[idx].astype(<span class="st">"float32"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> torch.FloatTensor(row[:<span class="op">-</span><span class="dv">5</span>].values)  <span class="co"># All columns except the last 5</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        year <span class="op">=</span> torch.FloatTensor([row[<span class="op">-</span><span class="dv">5</span>]]).to(torch.<span class="bu">int</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> torch.FloatTensor([row[<span class="op">-</span><span class="dv">4</span>]]).to(torch.<span class="bu">int</span>)  <span class="co"># Month is expected to be 0-11</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        day <span class="op">=</span> torch.FloatTensor([row[<span class="op">-</span><span class="dv">3</span>]]).to(torch.<span class="bu">int</span>)    <span class="co"># Day is expected to be 0-30</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        hour <span class="op">=</span> torch.FloatTensor([row[<span class="op">-</span><span class="dv">2</span>]]).to(torch.<span class="bu">int</span>)      <span class="co"># Hour is already 0-indexed (0-23)</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> torch.FloatTensor([row[<span class="op">-</span><span class="dv">1</span>]])  <span class="co"># The last column</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> features, year, month, day, hour, label</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.dataframe)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_data_loaders(data, chunk_size, batch_size):</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> np.array_split(data, <span class="bu">len</span>(data) <span class="op">//</span> chunk_size)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    data_loaders <span class="op">=</span> []</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> chunks:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> CustomDataset(chunk)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        data_loader <span class="op">=</span> DataLoader(dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>, drop_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        data_loaders.append(data_loader)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_loaders</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co"># In[13]:</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_function(net, criterion, optimizer, data_loaders, n_epochs<span class="op">=</span><span class="dv">5</span>, device<span class="op">=</span>torch.device(<span class="st">"cuda"</span>)):</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> torch.optim.lr_scheduler <span class="im">import</span> ReduceLROnPlateau</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    scheduler <span class="op">=</span> ReduceLROnPlateau(optimizer, <span class="st">'min'</span>, verbose<span class="op">=</span><span class="va">True</span>, threshold<span class="op">=</span><span class="fl">0.1</span>, patience<span class="op">=</span><span class="dv">3</span>, factor<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(n_epochs)):</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        epoch_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data_loader <span class="kw">in</span> data_loaders:</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> features, year, month, day, hour, labels <span class="kw">in</span> tqdm(data_loader):</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                features <span class="op">=</span> features.to(device)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                year <span class="op">=</span> year.to(device)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                month <span class="op">=</span> month.to(device)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                day <span class="op">=</span> day.to(device)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                hour <span class="op">=</span> hour.to(device)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                labels <span class="op">=</span> labels.to(device)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> net(features, month, day, hour, year)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> criterion(outputs, labels)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>                epoch_loss <span class="op">+=</span> loss</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                optimizer.zero_grad()</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>                loss.backward()</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                optimizer.step()</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        scheduler.step(epoch_loss <span class="op">/</span> <span class="bu">len</span>(data_loaders))</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">, Loss: </span><span class="sc">{</span>epoch_loss <span class="op">/</span> <span class="bu">len</span>(data_loaders)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'modelcheckpoint</span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">.pickle'</span>, <span class="st">'wb'</span>) <span class="im">as</span> handle:</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            pickle.dump([net, optimizer], handle, protocol<span class="op">=</span>pickle.HIGHEST_PROTOCOL)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        collected <span class="op">=</span> gc.collect()</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> net</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_function(net, data_loaders, scaler, label_scaler, device<span class="op">=</span>torch.device(<span class="st">"cuda"</span>), return_data<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> MeanSquaredError().to(device)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    smape <span class="op">=</span> SymmetricMeanAbsolutePercentageError().to(device)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    net.<span class="bu">eval</span>()</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    list_outputs <span class="op">=</span> []</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    list_targets <span class="op">=</span> []</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():  <span class="co"># to not reserve a memory space for gradients</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data_loader <span class="kw">in</span> data_loaders:</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> features, year, month, day, hour, labels <span class="kw">in</span> tqdm(data_loader):</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>                features <span class="op">=</span> features.to(device)</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                year <span class="op">=</span> year.to(device)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                month <span class="op">=</span> month.to(device)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                day <span class="op">=</span> day.to(device)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>                hour <span class="op">=</span> hour.to(device)</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                labels <span class="op">=</span> labels.to(device)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> net(features, month, day, hour, year)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> outputs.squeeze()</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                labels <span class="op">=</span> labels.squeeze()</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                mse(outputs, labels)</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                smape(outputs, labels)</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>                list_targets.append(labels.detach().unsqueeze(<span class="dv">0</span>))  <span class="co"># Ensure tensors are at least one-dimensional</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>                list_outputs.append(outputs.detach().unsqueeze(<span class="dv">0</span>))  <span class="co"># Ensure tensors are at least one-dimensional</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    test_mse <span class="op">=</span> mse.compute()</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    test_smape <span class="op">=</span> smape.compute()</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Test MSE: </span><span class="sc">{</span>test_mse<span class="sc">}</span><span class="ss"> , SMAPE </span><span class="sc">{</span>test_smape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> return_data:</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.cat(list_outputs), torch.cat(list_targets), test_mse, test_smape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="00b9b802-3c4a-4d4d-a8e4-bdf1b7a64625" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to create the model for memory profiling</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model():</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> CombinedModel(nbits_params, embedding_dim, final_hidden)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_memory_usage():</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resource.getrusage(resource.RUSAGE_SELF).ru_maxrss <span class="op">/</span> <span class="dv">1024</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TrendBlock(nn.Module):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size, output_size, num_hidden, num_layers):</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(TrendBlock, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc <span class="op">=</span> nn.ModuleList([nn.Linear(input_size, num_hidden)] <span class="op">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                                [nn.Linear(num_hidden, num_hidden) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_layers <span class="op">-</span> <span class="dv">1</span>)])</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backcast_fc <span class="op">=</span> nn.Linear(num_hidden, input_size)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast_fc <span class="op">=</span> nn.Linear(num_hidden, output_size)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.fc:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(layer(x))</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        backcast <span class="op">=</span> <span class="va">self</span>.backcast_fc(x)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        forecast <span class="op">=</span> <span class="va">self</span>.forecast_fc(x)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> backcast, forecast</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SeasonalityBlock(nn.Module):</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size, output_size, num_hidden, num_layers):</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(SeasonalityBlock, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc <span class="op">=</span> nn.ModuleList([nn.Linear(input_size, num_hidden)] <span class="op">+</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                                [nn.Linear(num_hidden, num_hidden) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_layers <span class="op">-</span> <span class="dv">1</span>)])</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.backcast_fc <span class="op">=</span> nn.Linear(num_hidden, input_size)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast_fc <span class="op">=</span> nn.Linear(num_hidden, output_size)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.fc:</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> torch.relu(layer(x))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        backcast <span class="op">=</span> <span class="va">self</span>.backcast_fc(x)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        forecast <span class="op">=</span> <span class="va">self</span>.forecast_fc(x)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> backcast, forecast</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NBEATS(nn.Module):</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size, output_size, num_hidden, num_layers, num_blocks):</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(NBEATS, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trend_blocks <span class="op">=</span> nn.ModuleList([TrendBlock(input_size, output_size, num_hidden, num_layers) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks <span class="op">//</span> <span class="dv">2</span>)])</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seasonality_blocks <span class="op">=</span> nn.ModuleList([SeasonalityBlock(input_size, output_size, num_hidden, num_layers) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks <span class="op">//</span> <span class="dv">2</span>)])</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        backcast, forecast <span class="op">=</span> x, <span class="dv">0</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> <span class="va">self</span>.trend_blocks:</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>            backcast, block_forecast <span class="op">=</span> block(x)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> x <span class="op">-</span> backcast</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>            forecast <span class="op">=</span> forecast <span class="op">+</span> block_forecast</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> <span class="va">self</span>.seasonality_blocks:</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>            backcast, block_forecast <span class="op">=</span> block(x)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> x <span class="op">-</span> backcast</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>            forecast <span class="op">=</span> forecast <span class="op">+</span> block_forecast</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> forecast</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EmbeddingNetwork(nn.Module):</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_embeddings, embedding_dim):</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(EmbeddingNetwork, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding <span class="op">=</span> nn.Embedding(num_embeddings, embedding_dim)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.embedding(x)</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> YearNetwork(nn.Module):</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim, num_hidden):</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(YearNetwork, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden <span class="op">=</span> nn.Linear(input_dim, <span class="dv">25</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output <span class="op">=</span> nn.Linear(<span class="dv">25</span>, num_hidden)</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.relu(<span class="va">self</span>.hidden(x))</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.output(x)</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CombinedModel(nn.Module):</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, nbits_params, embedding_dim, final_hidden):</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(CombinedModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nbeats <span class="op">=</span> NBEATS(<span class="op">**</span>nbits_params)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.month_net <span class="op">=</span> EmbeddingNetwork(<span class="dv">12</span>, embedding_dim)  <span class="co"># Months from 1 to 12</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.day_net <span class="op">=</span> EmbeddingNetwork(<span class="dv">31</span>, embedding_dim)    <span class="co"># Days from 1 to 31</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hour_net <span class="op">=</span> EmbeddingNetwork(<span class="dv">24</span>, embedding_dim)   <span class="co"># Hours from 0 to 23</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.year_net <span class="op">=</span> YearNetwork(<span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_layer <span class="op">=</span> nn.Sequential(</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>            <span class="co">#nn.Linear(embedding_dim * 3 + nbits_params['output_size'] + 10, final_hidden),</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>            nn.Linear(embedding_dim <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> nbits_params[<span class="st">'output_size'</span>], final_hidden),</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>            nn.Linear(final_hidden, <span class="dv">1</span>)</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, month, day, hour, year):</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>        ts_output <span class="op">=</span> <span class="va">self</span>.nbeats(x)</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print('TS', ts_output)</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>        month_output <span class="op">=</span> <span class="va">self</span>.month_net(month.<span class="bu">long</span>()).squeeze(<span class="dv">1</span>)</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print('Month', month_output)</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>        day_output <span class="op">=</span> <span class="va">self</span>.day_net(day.<span class="bu">long</span>()).squeeze(<span class="dv">1</span>)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print('Day', day_output)</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>        hour_output <span class="op">=</span> <span class="va">self</span>.hour_net(hour.<span class="bu">long</span>()).squeeze(<span class="dv">1</span>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print('Hour', hour_output)</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print('Year', year_output)</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>        <span class="co">#combined_output = torch.cat((ts_output, month_output, day_output, hour_output, year_output), dim=1)</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        combined_output <span class="op">=</span> torch.cat((ts_output, month_output, day_output, hour_output), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>        final_output <span class="op">=</span> <span class="va">self</span>.final_layer(combined_output)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> final_output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="915da287-825c-49ac-ac5a-1e38bfd2dc68" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>input_size <span class="op">=</span> <span class="dv">40</span>  <span class="co"># Length of input time series</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>output_size <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Length of output time series (forecast)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>num_blocks <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>num_hidden <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>num_layers <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>embedding_dim <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>final_hidden <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>nbits_params <span class="op">=</span> {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'input_size'</span>: input_size,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'output_size'</span>: output_size,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_blocks'</span>: num_blocks,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_hidden'</span>: num_hidden,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_layers'</span>: num_layers</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2065ba64-f246-4eb3-8dac-bd3cde7389ea" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> create_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5aaf404f-b16f-4ffb-85aa-693ad1599320" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>trained_model <span class="op">=</span> torch.load(<span class="st">'trained_model.pth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="54946003-24ca-4314-8094-917f235075e7" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>trained_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CombinedModel(
  (nbeats): NBEATS(
    (trend_blocks): ModuleList(
      (0-5): 6 x TrendBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=512, bias=True)
          (1-7): 7 x Linear(in_features=512, out_features=512, bias=True)
        )
        (backcast_fc): Linear(in_features=512, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=512, out_features=1, bias=True)
      )
    )
    (seasonality_blocks): ModuleList(
      (0-5): 6 x SeasonalityBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=512, bias=True)
          (1-7): 7 x Linear(in_features=512, out_features=512, bias=True)
        )
        (backcast_fc): Linear(in_features=512, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=512, out_features=1, bias=True)
      )
    )
  )
  (month_net): EmbeddingNetwork(
    (embedding): Embedding(12, 10)
  )
  (day_net): EmbeddingNetwork(
    (embedding): Embedding(31, 10)
  )
  (hour_net): EmbeddingNetwork(
    (embedding): Embedding(24, 10)
  )
  (year_net): YearNetwork(
    (hidden): Linear(in_features=1, out_features=25, bias=True)
    (output): Linear(in_features=25, out_features=10, bias=True)
  )
  (final_layer): Sequential(
    (0): Linear(in_features=31, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1, bias=True)
  )
)</code></pre>
</div>
</div>
<div id="2ea185d1-6738-4327-b5d8-bb152732963e" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>n_epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>window_size <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>chunk_size <span class="op">=</span> <span class="dv">122880</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1024</span><span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">5</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># In[15]:</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming `train`, `test`, `sample` are pre-loaded DataFrames</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>train_loaders <span class="op">=</span> create_data_loaders(train, chunk_size, batch_size)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>test_loaders <span class="op">=</span> create_data_loaders(test, chunk_size, batch_size)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>sample_loaders <span class="op">=</span> create_data_loaders(sample, <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">"cuda"</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>net.to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CombinedModel(
  (nbeats): NBEATS(
    (trend_blocks): ModuleList(
      (0-5): 6 x TrendBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=512, bias=True)
          (1-7): 7 x Linear(in_features=512, out_features=512, bias=True)
        )
        (backcast_fc): Linear(in_features=512, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=512, out_features=1, bias=True)
      )
    )
    (seasonality_blocks): ModuleList(
      (0-5): 6 x SeasonalityBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=512, bias=True)
          (1-7): 7 x Linear(in_features=512, out_features=512, bias=True)
        )
        (backcast_fc): Linear(in_features=512, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=512, out_features=1, bias=True)
      )
    )
  )
  (month_net): EmbeddingNetwork(
    (embedding): Embedding(12, 10)
  )
  (day_net): EmbeddingNetwork(
    (embedding): Embedding(31, 10)
  )
  (hour_net): EmbeddingNetwork(
    (embedding): Embedding(24, 10)
  )
  (year_net): YearNetwork(
    (hidden): Linear(in_features=1, out_features=25, bias=True)
    (output): Linear(in_features=25, out_features=10, bias=True)
  )
  (final_layer): Sequential(
    (0): Linear(in_features=31, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1, bias=True)
  )
)</code></pre>
</div>
</div>
<div id="a7df2e2a-f104-45ed-8363-603b8c432b99" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>_, test_mse, test_smape <span class="op">=</span> test_function(trained_model, test_loaders, <span class="va">None</span>, <span class="va">None</span>, torch.device(device), return_data<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dde57410b5d54bb18b48c683e36a4ce8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3af0dc3e81cb41478e153f26ae446051","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Test MSE: 1.037216067314148 , SMAPE 0.4622192978858948</code></pre>
</div>
</div>
<div id="e47d5587-b1cb-4815-afab-e533857cfee6" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>test_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(1.0372, device='cuda:0')</code></pre>
</div>
</div>
<div id="9e08171d-a10e-49b1-b849-9af38d08948e" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>test_smape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0.4622, device='cuda:0')</code></pre>
</div>
</div>
<div id="027694ee-7a4a-410a-a66c-4c4672c0b78f" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch_pruning <span class="im">as</span> tp</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch_pruning.pruner <span class="im">import</span> function</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fasterai.core.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> onnx</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> onnxruntime <span class="im">as</span> ort</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> onnxruntime <span class="im">import</span> quantization</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> cycle</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.basics <span class="im">import</span> store_attr, listify, true</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fasterbench.benchmark <span class="im">import</span> <span class="op">*</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ignored_layers(model):</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    ignored_layers <span class="op">=</span> []</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check and process trend blocks if they exist</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model.nbeats, <span class="st">'trend_blocks'</span>):</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> model.nbeats.trend_blocks:</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(block, <span class="st">'backcast_fc'</span>):</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                ignored_layers.append(block.backcast_fc)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(block, <span class="st">'forecast_fc'</span>):</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                ignored_layers.append(block.forecast_fc)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check and process seasonality blocks if they exist</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model.nbeats, <span class="st">'seasonality_blocks'</span>):</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> model.nbeats.seasonality_blocks:</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(block, <span class="st">'backcast_fc'</span>):</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                ignored_layers.append(block.backcast_fc)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(block, <span class="st">'forecast_fc'</span>):</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                ignored_layers.append(block.forecast_fc)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ignored_layers</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_layer_features(layer, pruning_ratio):</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(layer, <span class="st">'in_features'</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(layer, <span class="st">'weight'</span>):</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        in_features <span class="op">=</span> layer.in_features</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        layer.in_features <span class="op">=</span> <span class="bu">int</span>(in_features <span class="op">*</span> (<span class="dv">1</span><span class="op">-</span>pruning_ratio))</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        local_scores <span class="op">=</span> large_final(layer, <span class="st">'column'</span>)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        threshold <span class="op">=</span> torch.quantile(local_scores.view(<span class="op">-</span><span class="dv">1</span>), pruning_ratio)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> local_scores.ge(threshold).to(dtype<span class="op">=</span>local_scores.dtype)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        ixs <span class="op">=</span> torch.nonzero(mask[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">1</span>, as_tuple<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        layer.weight.data <span class="op">=</span> layer.weight[:, ixs]</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prune_model(model, pruning_ratio, dummy_input):</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    imp <span class="op">=</span> tp.importance.GroupNormImportance(p<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    ignored_layers <span class="op">=</span> get_ignored_layers(model)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    pruner <span class="op">=</span> tp.pruner.MetaPruner(</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        model.nbeats,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        dummy_input,</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        importance<span class="op">=</span>imp,</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        pruning_ratio<span class="op">=</span>pruning_ratio, </span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        ignored_layers<span class="op">=</span>ignored_layers</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    pruner.step()</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model.nbeats, <span class="st">'trend_blocks'</span>):</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> model.nbeats.trend_blocks:</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> layer <span class="kw">in</span> [block.backcast_fc, block.forecast_fc]:</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> layer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> layer.in_features <span class="op">!=</span> <span class="bu">int</span>(num_hidden<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>pruning_ratio)):</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>                    adjust_layer_features(layer, pruning_ratio)</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(model.nbeats, <span class="st">'seasonality_blocks'</span>):</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> block <span class="kw">in</span> model.nbeats.seasonality_blocks:</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> layer <span class="kw">in</span> [block.backcast_fc, block.forecast_fc]:</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> layer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> layer.in_features <span class="op">!=</span> <span class="bu">int</span>(num_hidden<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>pruning_ratio)):</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>                    adjust_layer_features(layer, pruning_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1144715e-4391-47fb-959a-f7926a5ecba5" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>num_parameters <span class="op">=</span> get_num_parameters(trained_model)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>disk_size <span class="op">=</span> get_model_size(trained_model)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model Size: </span><span class="sc">{</span>disk_size <span class="op">/</span> <span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB (disk), </span><span class="sc">{</span>num_parameters<span class="sc">}</span><span class="ss"> parameters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[6], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> num_parameters <span style="color:rgb(98,98,98)">=</span> get_num_parameters(<span class="ansi-yellow-bg">trained_model</span>)
<span class="ansi-green-fg ansi-bold">      2</span> disk_size <span style="color:rgb(98,98,98)">=</span> get_model_size(trained_model)
<span class="ansi-green-fg ansi-bold">      3</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Model Size: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>disk_size<span style="color:rgb(188,188,188)"> </span><span style="color:rgb(98,98,98)">/</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(98,98,98)">1e6</span><span style="font-weight:bold;color:rgb(175,95,135)">:</span><span style="color:rgb(175,0,0)">.2f</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> MB (disk), </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>num_parameters<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> parameters</span><span style="color:rgb(175,0,0)">"</span>)

<span class="ansi-red-fg">NameError</span>: name 'trained_model' is not defined</pre>
</div>
</div>
</div>
<div id="8c9cd4ef-a734-4535-b527-63f1cad7c37f" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>num_features <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> torch.randn(batch_size, num_features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6458ae8b-3b4e-48ea-a48a-e0ecb040a7c8" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>trained_model <span class="op">=</span> torch.load(<span class="st">'trained_model.pth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="35168432-3705-4c78-9b20-74d8ce1629cb" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>prune_model(trained_model, <span class="fl">0.15</span>, features.to(<span class="st">'cuda'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2f84a4a7-3f5a-433d-8280-0a58a578b905" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>num_parameters <span class="op">=</span> get_num_parameters(trained_model)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>disk_size <span class="op">=</span> get_model_size(trained_model)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model Size: </span><span class="sc">{</span>disk_size <span class="op">/</span> <span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB (disk), </span><span class="sc">{</span>num_parameters<span class="sc">}</span><span class="ss"> parameters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model Size: 65.56 MB (disk), 16369401 parameters</code></pre>
</div>
</div>
<div id="ace20f89-1479-4177-89f0-692507888ae7" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>_, test_mse, test_smape <span class="op">=</span> test_function(trained_model, test_loaders, <span class="va">None</span>, <span class="va">None</span>, torch.device(device), return_data<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c834263153da4f8e95b83c475ac95754","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"21e71e5cd5dd4dae908db0d5a7ad2d9b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Test MSE: 1.1977158784866333 , SMAPE 0.4805765748023987</code></pre>
</div>
</div>
<div id="572fe6e8-8fef-459e-bf8a-49ca29df6459" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>test_mse, test_smape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(1.9425, device='cuda:0'), tensor(0.7663, device='cuda:0'))</code></pre>
</div>
</div>
<div id="68909950-270a-419d-b87b-b7f6aee88670" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> onnxruntime.quantization <span class="im">import</span> quantize_dynamic, QuantType</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4c42751d-9856-4553-815c-81c8583fbeb6" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> script_model(model, dummy_input, path<span class="op">=</span><span class="st">'scripted_model.pt'</span>):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    scripted_model <span class="op">=</span> torch.jit.trace(model, dummy_input)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    scripted_model.save(path)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scripted_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="29210369-795b-4e58-b7bc-df860ba99d26" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quantize_onnx(model, dummy_input, onnx_path<span class="op">=</span><span class="st">"model.onnx"</span>, quant_onnx_path<span class="op">=</span><span class="st">"model_quantized.onnx"</span>):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    torch.onnx.export(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    model,              </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    dummy_input,        </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    onnx_path, </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    input_names<span class="op">=</span>[<span class="st">"features"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"hour"</span>],   </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    output_names<span class="op">=</span>[<span class="st">"output"</span>], </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    dynamic_axes<span class="op">=</span>{<span class="st">"input"</span>: {<span class="dv">0</span>: <span class="st">"batch_size"</span>}, <span class="st">"output"</span>: {<span class="dv">0</span>: <span class="st">"batch_size"</span>}}, </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    opset_version<span class="op">=</span><span class="dv">11</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    quantize_dynamic(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        onnx_path,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        quant_onnx_path,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        weight_type<span class="op">=</span>QuantType.QUInt8</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8dfbf777-784e-43e2-a11e-908a50c48ad0" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>num_features <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> torch.randn(batch_size, num_features)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>month <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="dv">12</span>, (batch_size, <span class="dv">1</span>))      <span class="co"># Random months between 1 and 12</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>day <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="dv">31</span>, (batch_size, <span class="dv">1</span>))        <span class="co"># Random days between 1 and 31</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>hour <span class="op">=</span> torch.randint(<span class="dv">0</span>, <span class="dv">24</span>, (batch_size, <span class="dv">1</span>))       <span class="co"># Random hours between 0 and 23</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>year <span class="op">=</span> torch.randint(<span class="dv">2019</span>, <span class="dv">2021</span>, (batch_size, <span class="dv">1</span>)) </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>example_input <span class="op">=</span> features, year, month, day, hour</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="70d42009-f96c-41b6-b212-a2d94dea2f89" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>trained_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CombinedModel(
  (nbeats): NBEATS(
    (trend_blocks): ModuleList(
      (0-5): 6 x TrendBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=435, bias=True)
          (1-7): 7 x Linear(in_features=435, out_features=435, bias=True)
        )
        (backcast_fc): Linear(in_features=435, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=435, out_features=1, bias=True)
      )
    )
    (seasonality_blocks): ModuleList(
      (0-5): 6 x SeasonalityBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=435, bias=True)
          (1-7): 7 x Linear(in_features=435, out_features=435, bias=True)
        )
        (backcast_fc): Linear(in_features=435, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=435, out_features=1, bias=True)
      )
    )
  )
  (month_net): EmbeddingNetwork(
    (embedding): Embedding(12, 10)
  )
  (day_net): EmbeddingNetwork(
    (embedding): Embedding(31, 10)
  )
  (hour_net): EmbeddingNetwork(
    (embedding): Embedding(24, 10)
  )
  (year_net): YearNetwork(
    (hidden): Linear(in_features=1, out_features=25, bias=True)
    (output): Linear(in_features=25, out_features=10, bias=True)
  )
  (final_layer): Sequential(
    (0): Linear(in_features=31, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1, bias=True)
  )
)</code></pre>
</div>
</div>
<div id="33c7292e-37af-4911-9df6-b4cabc9433a0" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>trained_model.to(<span class="st">'cpu'</span>)(<span class="op">*</span>example_input)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">IndexError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[22], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">trained_model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">to</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">cpu</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">example_input</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[3], line 93</span>, in <span class="ansi-cyan-fg">CombinedModel.forward</span><span class="ansi-blue-fg">(self, x, month, day, hour, year)</span>
<span class="ansi-green-fg ansi-bold">     91</span> ts_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>nbeats(x)
<span class="ansi-green-fg ansi-bold">     92</span> <span style="font-style:italic;color:rgb(95,135,135)">#print('TS', ts_output)</span>
<span class="ansi-green-fg">---&gt; 93</span> month_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">month_net</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">month</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">long</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span><span style="color:rgb(98,98,98)">.</span>squeeze(<span style="color:rgb(98,98,98)">1</span>)
<span class="ansi-green-fg ansi-bold">     94</span> <span style="font-style:italic;color:rgb(95,135,135)">#print('Month', month_output)</span>
<span class="ansi-green-fg ansi-bold">     95</span> day_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>day_net(day<span style="color:rgb(98,98,98)">.</span>long())<span style="color:rgb(98,98,98)">.</span>squeeze(<span style="color:rgb(98,98,98)">1</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[3], line 63</span>, in <span class="ansi-cyan-fg">EmbeddingNetwork.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     62</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">---&gt; 63</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/sparse.py:163</span>, in <span class="ansi-cyan-fg">Embedding.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    162</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 163</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    164</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">padding_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">max_norm</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    165</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">norm_type</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">scale_grad_by_freq</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sparse</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/functional.py:2237</span>, in <span class="ansi-cyan-fg">embedding</span><span class="ansi-blue-fg">(input, weight, padding_idx, max_norm, norm_type, scale_grad_by_freq, sparse)</span>
<span class="ansi-green-fg ansi-bold">   2231</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Note [embedding_renorm set_grad_enabled]</span>
<span class="ansi-green-fg ansi-bold">   2232</span>     <span style="font-style:italic;color:rgb(95,135,135)"># XXX: equivalent to</span>
<span class="ansi-green-fg ansi-bold">   2233</span>     <span style="font-style:italic;color:rgb(95,135,135)"># with torch.no_grad():</span>
<span class="ansi-green-fg ansi-bold">   2234</span>     <span style="font-style:italic;color:rgb(95,135,135)">#   torch.embedding_renorm_</span>
<span class="ansi-green-fg ansi-bold">   2235</span>     <span style="font-style:italic;color:rgb(95,135,135)"># remove once script supports set_grad_enabled</span>
<span class="ansi-green-fg ansi-bold">   2236</span>     _no_grad_embedding_renorm_(weight, <span style="color:rgb(0,135,0)">input</span>, max_norm, norm_type)
<span class="ansi-green-fg">-&gt; 2237</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">padding_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">scale_grad_by_freq</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">sparse</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">IndexError</span>: index out of range in self</pre>
</div>
</div>
</div>
<div id="0048f3b2-7f0d-4cb2-93a6-21abb4ba4834" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>scripted_model <span class="op">=</span> script_model(trained_model.to(<span class="st">'cpu'</span>), example_input)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>quantize_onnx(net, example_input)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">IndexError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[15], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> scripted_model <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">script_model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trained_model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">to</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">cpu</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">example_input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> quantize_onnx(net, example_input)

Cell <span class="ansi-green-fg">In[12], line 2</span>, in <span class="ansi-cyan-fg">script_model</span><span class="ansi-blue-fg">(model, dummy_input, path)</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">script_model</span>(model, dummy_input, path<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">scripted_model.pt</span><span style="color:rgb(175,0,0)">'</span>):
<span class="ansi-green-fg">----&gt; 2</span>     scripted_model <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">jit</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">trace</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dummy_input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      3</span>     scripted_model<span style="color:rgb(98,98,98)">.</span>save(path)
<span class="ansi-green-fg ansi-bold">      4</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> scripted_model

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/jit/_trace.py:806</span>, in <span class="ansi-cyan-fg">trace</span><span class="ansi-blue-fg">(func, example_inputs, optimize, check_trace, check_inputs, check_tolerance, strict, _force_outplace, _module_class, _compilation_unit, example_kwarg_inputs, _store_inputs)</span>
<span class="ansi-green-fg ansi-bold">    804</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    805</span>             <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">example_kwarg_inputs should be a dict</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">--&gt; 806</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trace_module</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    807</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    808</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">{</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">forward</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">example_inputs</span><span class="ansi-yellow-bg">}</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    809</span> <span class="ansi-yellow-bg">        </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    810</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">check_trace</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    811</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">wrap_check_inputs</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">check_inputs</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    812</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">check_tolerance</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    813</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">strict</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    814</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">_force_outplace</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    815</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">_module_class</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    816</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">example_inputs_is_kwarg</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">isinstance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">example_kwarg_inputs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">dict</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    817</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">_store_inputs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_store_inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    818</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    819</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> (
<span class="ansi-green-fg ansi-bold">    820</span>     <span style="color:rgb(0,135,0)">hasattr</span>(func, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">__self__</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    821</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">isinstance</span>(func<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__self__</span>, torch<span style="color:rgb(98,98,98)">.</span>nn<span style="color:rgb(98,98,98)">.</span>Module)
<span class="ansi-green-fg ansi-bold">    822</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> func<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span> <span style="color:rgb(98,98,98)">==</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">forward</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    823</span> ):
<span class="ansi-green-fg ansi-bold">    824</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> example_inputs <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/jit/_trace.py:1074</span>, in <span class="ansi-cyan-fg">trace_module</span><span class="ansi-blue-fg">(mod, inputs, optimize, check_trace, check_inputs, check_tolerance, strict, _force_outplace, _module_class, _compilation_unit, example_inputs_is_kwarg, _store_inputs)</span>
<span class="ansi-green-fg ansi-bold">   1072</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">   1073</span>     example_inputs <span style="color:rgb(98,98,98)">=</span> make_tuple(example_inputs)
<span class="ansi-green-fg">-&gt; 1074</span>     <span class="ansi-yellow-bg">module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_c</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_create_method_from_trace</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1075</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">method_name</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1076</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1077</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">example_inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1078</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">var_lookup_fn</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1079</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">strict</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1080</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">_force_outplace</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1081</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">argument_names</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1082</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">_store_inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1083</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1085</span> check_trace_method <span style="color:rgb(98,98,98)">=</span> module<span style="color:rgb(98,98,98)">.</span>_c<span style="color:rgb(98,98,98)">.</span>_get_method(method_name)
<span class="ansi-green-fg ansi-bold">   1087</span> <span style="font-style:italic;color:rgb(95,135,135)"># Check the trace against new traces created from user-specified inputs</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1501</span>, in <span class="ansi-cyan-fg">Module._slow_forward</span><span class="ansi-blue-fg">(self, *input, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1499</span>         recording_scopes <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg ansi-bold">   1500</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; 1501</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1502</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">   1503</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> recording_scopes:

Cell <span class="ansi-green-fg">In[3], line 93</span>, in <span class="ansi-cyan-fg">CombinedModel.forward</span><span class="ansi-blue-fg">(self, x, month, day, hour, year)</span>
<span class="ansi-green-fg ansi-bold">     91</span> ts_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>nbeats(x)
<span class="ansi-green-fg ansi-bold">     92</span> <span style="font-style:italic;color:rgb(95,135,135)">#print('TS', ts_output)</span>
<span class="ansi-green-fg">---&gt; 93</span> month_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">month_net</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">month</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">long</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span><span style="color:rgb(98,98,98)">.</span>squeeze(<span style="color:rgb(98,98,98)">1</span>)
<span class="ansi-green-fg ansi-bold">     94</span> <span style="font-style:italic;color:rgb(95,135,135)">#print('Month', month_output)</span>
<span class="ansi-green-fg ansi-bold">     95</span> day_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>day_net(day<span style="color:rgb(98,98,98)">.</span>long())<span style="color:rgb(98,98,98)">.</span>squeeze(<span style="color:rgb(98,98,98)">1</span>)

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1501</span>, in <span class="ansi-cyan-fg">Module._slow_forward</span><span class="ansi-blue-fg">(self, *input, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1499</span>         recording_scopes <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg ansi-bold">   1500</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; 1501</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1502</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">   1503</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> recording_scopes:

Cell <span class="ansi-green-fg">In[3], line 63</span>, in <span class="ansi-cyan-fg">EmbeddingNetwork.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     62</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">---&gt; 63</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1511</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1509</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1510</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1511</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1520</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1515</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1516</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1517</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1518</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1519</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1520</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1522</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1523</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/module.py:1501</span>, in <span class="ansi-cyan-fg">Module._slow_forward</span><span class="ansi-blue-fg">(self, *input, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1499</span>         recording_scopes <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg ansi-bold">   1500</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; 1501</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1502</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">   1503</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> recording_scopes:

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/modules/sparse.py:163</span>, in <span class="ansi-cyan-fg">Embedding.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    162</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 163</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    164</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">padding_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">max_norm</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    165</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">norm_type</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">scale_grad_by_freq</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sparse</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/miniconda3/envs/dev/lib/python3.9/site-packages/torch/nn/functional.py:2237</span>, in <span class="ansi-cyan-fg">embedding</span><span class="ansi-blue-fg">(input, weight, padding_idx, max_norm, norm_type, scale_grad_by_freq, sparse)</span>
<span class="ansi-green-fg ansi-bold">   2231</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Note [embedding_renorm set_grad_enabled]</span>
<span class="ansi-green-fg ansi-bold">   2232</span>     <span style="font-style:italic;color:rgb(95,135,135)"># XXX: equivalent to</span>
<span class="ansi-green-fg ansi-bold">   2233</span>     <span style="font-style:italic;color:rgb(95,135,135)"># with torch.no_grad():</span>
<span class="ansi-green-fg ansi-bold">   2234</span>     <span style="font-style:italic;color:rgb(95,135,135)">#   torch.embedding_renorm_</span>
<span class="ansi-green-fg ansi-bold">   2235</span>     <span style="font-style:italic;color:rgb(95,135,135)"># remove once script supports set_grad_enabled</span>
<span class="ansi-green-fg ansi-bold">   2236</span>     _no_grad_embedding_renorm_(weight, <span style="color:rgb(0,135,0)">input</span>, max_norm, norm_type)
<span class="ansi-green-fg">-&gt; 2237</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">embedding</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">padding_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">scale_grad_by_freq</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">sparse</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">IndexError</span>: index out of range in self</pre>
</div>
</div>
</div>
<div id="b48d68ee-7cd1-43a2-a506-cb2fe1fbf8fb" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>trained_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CombinedModel(
  (nbeats): NBEATS(
    (trend_blocks): ModuleList(
      (0-5): 6 x TrendBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=435, bias=True)
          (1-7): 7 x Linear(in_features=435, out_features=435, bias=True)
        )
        (backcast_fc): Linear(in_features=435, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=435, out_features=1, bias=True)
      )
    )
    (seasonality_blocks): ModuleList(
      (0-5): 6 x SeasonalityBlock(
        (fc): ModuleList(
          (0): Linear(in_features=40, out_features=435, bias=True)
          (1-7): 7 x Linear(in_features=435, out_features=435, bias=True)
        )
        (backcast_fc): Linear(in_features=435, out_features=40, bias=True)
        (forecast_fc): Linear(in_features=435, out_features=1, bias=True)
      )
    )
  )
  (month_net): EmbeddingNetwork(
    (embedding): Embedding(12, 10)
  )
  (day_net): EmbeddingNetwork(
    (embedding): Embedding(31, 10)
  )
  (hour_net): EmbeddingNetwork(
    (embedding): Embedding(24, 10)
  )
  (year_net): YearNetwork(
    (hidden): Linear(in_features=1, out_features=25, bias=True)
    (output): Linear(in_features=25, out_features=10, bias=True)
  )
  (final_layer): Sequential(
    (0): Linear(in_features=31, out_features=256, bias=True)
    (1): ReLU()
    (2): Linear(in_features=256, out_features=1, bias=True)
  )
)</code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nathanhubens\.github\.io\/TRAIL24");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><ul><li><a href="https://github.com/nathanhubens/TRAIL24/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>